{
  "paragraphs": [
    {
      "text": "%pyspark\n",
      "user": "ad\\scox",
      "dateUpdated": "Mar 24, 2017 5:00:17 PM",
      "config": {},
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1490389217441_1485748538",
      "id": "20170324-170017_1544840637",
      "dateCreated": "Mar 24, 2017 5:00:17 PM",
      "status": "READY",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%pyspark\nimport prov.model as prov\nimport re\nfrom datetime import datetime\nfrom datetime import date\n\nclass QueryResponseProvenance(object):\n    \"\"\" Abstract W3C PROV model of the provenance of components of a complex query. \"\"\"\n    def __init__(self, default_ns, namespaces\u003d[]):\n        \"\"\" Specify a default namespace and associated sub namespaces \"\"\"\n        self.document \u003d prov.ProvDocument ()\n        self.default_ns \u003d default_ns\n        self.document.set_default_namespace (self.default_ns)\n        self.namespaces \u003d namespaces\n        self.subspaces \u003d {}\n        for namespace in self.namespaces:\n            self.subspaces[namespace] \u003d self.add_namespace (self.default_ns, namespace)\n    def add_namespace (self, root, qualifier):\n        subspace \u003d \"{0}{1}\".format (root, qualifier)\n        self.document.add_namespace (qualifier, subspace)\n        return subspace\n    def add_entity (self, name, tuples):\n        self.document.entity (name, tuples)\n    def add_data_source (self, name, entity):\n        self.entity (name, entity.to_tuple ())\n    def add_algorithm (self, name, start, end\u003dNone):\n        assert name in self.namespaces, \"Name must be in list of namespaces\"\n        if end:\n            self.document.activity (name, start, end)\n        else:\n            self.document.activity (name, start)\n    def get_time (self):\n        return datetime.now ().strftime (\"%Y-%m-%dT%H:%M:%S\")\n    def __str__(self):\n        return self.__repr__()\n    def __repr__(self):\n        return self.document.get_provn ()\n        \nprovenance \u003d QueryResponseProvenance (\u0027http://purl.some.ns/\u0027, [ \u0027a\u0027, \u0027b\u0027, \u0027c\u0027 ])\n\nclass AbstractEntity(object):\n    def __init__(self, type, namespace, attributes\u003d[]):\n        self.attributes \u003d []\n        self.namespace \u003d namespace\n        self.attr_keys \u003d {}\n        self.add_attribute (prov.PROV_TYPE, type)\n        for a in attributes:\n            assert len(a) \u003d\u003d 2, \"Attribute components must be len\u003d\u003d2 arrays\"\n            self.add_attribute (a[0], a[1])\n    def add_attribute (self, iri, value):\n        key \u003d \u0027{0}@{1}\u0027.format (iri, value)\n        if not key in self.attr_keys:\n            self.attributes.append ((iri, value))\n            self.attr_keys[key] \u003d 1\n    def to_tuple (self):\n        return tuple(self.attributes)\n\ne \u003d AbstractEntity (\u0027SomeType\u0027, \u0027http://purl.some.ns/ae\u0027, )\ne.add_attribute (\u0027ds0\u0027, \u0027\u003chttp://all.ds.org/\u0027)\ne.add_attribute (\u0027ds1\u0027, \u0027\u003chttp://all.ds.org/\u0027)\nprovenance.add_entity (\u0027e\u0027, e.to_tuple ())\nprint (provenance.document.get_provn ())",
      "user": "ad\\scox",
      "dateUpdated": "Mar 24, 2017 10:15:30 PM",
      "config": {
        "colWidth": 12.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python"
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": [
          {
            "type": "TEXT",
            "data": "document\n  default \u003chttp://purl.some.ns/\u003e\n  prefix a \u003chttp://purl.some.ns/a\u003e\n  prefix c \u003chttp://purl.some.ns/c\u003e\n  prefix b \u003chttp://purl.some.ns/b\u003e\n  \n  entity(e, [prov:type\u003d\"SomeType\", ds0\u003d\"\u003chttp://all.ds.org/\", ds1\u003d\"\u003chttp://all.ds.org/\"])\nendDocument\n"
          }
        ]
      },
      "apps": [],
      "jobName": "paragraph_1490388079769_-1478794288",
      "id": "20170324-164119_865549647",
      "dateCreated": "Mar 24, 2017 4:41:19 PM",
      "dateStarted": "Mar 24, 2017 10:15:30 PM",
      "dateFinished": "Mar 24, 2017 10:15:30 PM",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%pyspark\n\n\u0027\u0027\u0027 DataLake Support \u0027\u0027\u0027\nclass DataLakeProvenance(QueryResponseProvenance):\n    PREFIX \u003d re.compile (\u0027^prefix \u0027, re.I)\n    def __init__(self, default_ns, namespaces\u003d[]):\n        QueryResponseProvenance.__init__(self, default_ns, namespaces)\n\n    def parse_sparql (self, query, source_map):\n        sources \u003d {}\n        for line in query.split (\u0027\\n\u0027):\n            line \u003d \u0027 \u0027.join (line.strip ().split ())\n            match \u003d self.PREFIX.match (line)\n            if match is None:\n                continue\n            if True:\n                parts \u003d line.strip().split (\u0027 \u0027)\n                if len(parts) \u003e\u003d 3:\n                    iri \u003d parts[2].strip ()\n                    e \u003d None\n                    for k, v in source_map.iteritems ():\n                        if k in iri:\n                            if v in sources:\n                                e \u003d sources[v]\n                            else:\n                                e \u003d AbstractEntity (\u0027data\u0027, \u0027{0}{1}\u0027.format (self.default_ns, v))\n                                sources[v] \u003d e\n                            e.add_attribute (\u0027src\u0027, v)\n                    if e is None:\n                        e \u003d AbstractEntity (\u0027data\u0027, \u0027http://purl.data.org/\u0027)\n                        e.add_attribute (\u0027src\u0027, iri)\n                        self.add_entity (\u0027data\u0027, e.to_tuple ())\n        for k, v in sources.iteritems ():\n            self.add_entity (\u0027data\u0027, v.to_tuple ())",
      "user": "ad\\scox",
      "dateUpdated": "Mar 24, 2017 10:15:51 PM",
      "config": {
        "colWidth": 12.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python"
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": []
      },
      "apps": [],
      "jobName": "paragraph_1490393461101_-181500383",
      "id": "20170324-181101_1881040132",
      "dateCreated": "Mar 24, 2017 6:11:01 PM",
      "dateStarted": "Mar 24, 2017 10:15:51 PM",
      "dateFinished": "Mar 24, 2017 10:15:51 PM",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%pyspark\nclass TranslatorProvenance (DataLakeProvenance):\n    def __init__(self):\n        DataLakeProvenance.__init__(\n            self,\n            default_ns \u003d \u0027http://purl.translator.org/prov/\u0027,\n            namespaces \u003d [\n                \u0027clinical\u0027, \u0027enviro\u0027, \u0027medbiochem\u0027,                            # data sources\n                \u0027exposure.pm25-ozone\u0027, \u0027clinical.med.prescribed\u0027, \u0027blazegraph\u0027 # algorithms / assumptions\n            ])\n    def parse_sparql (self, query):\n        super(TranslatorProvenance, self).parse_sparql (\n            query,\n            source_map \u003d {\n                \u0027\u003chttp://chem2bio2rdf.org/ctd/\u0027 : \u0027c2b2r.ctd\u0027,\n                \u0027GO_\u0027 : \u0027GO\u0027,\n                \u0027\u003chttp://chem2bio2rdf.org/drugbank\u0027 : \u0027c2b2r.drugbank\u0027,\n                \u0027monarch\u0027 : \u0027monarch\u0027\n            })",
      "user": "ad\\scox",
      "dateUpdated": "Mar 24, 2017 10:29:12 PM",
      "config": {
        "colWidth": 12.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python"
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": []
      },
      "apps": [],
      "jobName": "paragraph_1490393482161_1559534362",
      "id": "20170324-181122_2102261765",
      "dateCreated": "Mar 24, 2017 6:11:22 PM",
      "dateStarted": "Mar 24, 2017 10:29:13 PM",
      "dateFinished": "Mar 24, 2017 10:29:13 PM",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%pyspark\n\ndef test ():\n    sparql_query \u003d \"\"\"\n    PREFIX db_resource:      \u003chttp://chem2bio2rdf.org/drugbank/resource/\u003e\n    PREFIX ctd_chem_disease: \u003chttp://chem2bio2rdf.org/ctd/resource/ctd_chem_disease/\u003e \n    PREFIX biordf:           \u003chttp://bio2rdf.org/\u003e\n    PREFIX ctd:              \u003chttp://chem2bio2rdf.org/ctd/resource/\u003e\n    SELECT DISTINCT ?chem_disease ?meshid ?compound ?drug\n    WHERE {\n      ?chem_disease ctd:diseaseid ?meshid .\n      ?chem_disease ctd:cid       ?compound .\n      ?drug         db_resource:CID ?compound\n    }\"\"\"\n\n    p \u003d TranslatorProvenance ()\n    p.parse_sparql (sparql_query)\n    start \u003d p.get_time ()\n    end \u003d p.get_time ()\n    p.add_algorithm (\u0027clinical.med.prescribed\u0027, start)\n    p.add_algorithm (\u0027exposure.pm25-ozone\u0027, start, end)\n    print (p)\n\n\ntest ()\n",
      "user": "ad\\scox",
      "dateUpdated": "Mar 24, 2017 10:29:15 PM",
      "config": {
        "colWidth": 11.0,
        "enabled": true,
        "results": {
          "0": {
            "graph": {
              "mode": "table",
              "height": 405.0,
              "optionOpen": false
            }
          }
        },
        "editorSetting": {
          "language": "python"
        },
        "editorMode": "ace/mode/python",
        "lineNumbers": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": [
          {
            "type": "TEXT",
            "data": "document\n  default \u003chttp://purl.translator.org/prov/\u003e\n  prefix exposure.pm25-ozone \u003chttp://purl.translator.org/prov/exposure.pm25-ozone\u003e\n  prefix clinical \u003chttp://purl.translator.org/prov/clinical\u003e\n  prefix medbiochem \u003chttp://purl.translator.org/prov/medbiochem\u003e\n  prefix blazegraph \u003chttp://purl.translator.org/prov/blazegraph\u003e\n  prefix enviro \u003chttp://purl.translator.org/prov/enviro\u003e\n  prefix clinical.med.prescribed \u003chttp://purl.translator.org/prov/clinical.med.prescribed\u003e\n  \n  entity(data, [prov:type\u003d\"data\", src\u003d\"\u003chttp://bio2rdf.org/\u003e\"])\n  entity(data, [prov:type\u003d\"data\", src\u003d\"c2b2r.drugbank\"])\n  entity(data, [prov:type\u003d\"data\", src\u003d\"c2b2r.ctd\"])\n  activity(clinical.med.prescribed, 2017-03-24T22:29:15, -)\n  activity(exposure.pm25-ozone, 2017-03-24T22:29:15, 2017-03-24T22:29:15)\nendDocument\n"
          }
        ]
      },
      "apps": [],
      "jobName": "paragraph_1490377578176_1075105290",
      "id": "20170324-134618_408304644",
      "dateCreated": "Mar 24, 2017 1:46:18 PM",
      "dateStarted": "Mar 24, 2017 10:29:15 PM",
      "dateFinished": "Mar 24, 2017 10:29:15 PM",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%pyspark\ndef provenance_aspect (provenance, algorithms\u003d[]):\n    def provenance_aspect(function):\n        def wrapper(*args, **kwargs):\n            start \u003d provenance.get_time ()\n            function(*args, **kwargs)\n            end \u003d provenance.get_time ()\n            if \u0027patient\u0027 in function.__name__ or \u0027clinical\u0027 in function.__name__:\n                datasource \u003d \u0027clinical\u0027\n                provenance.add_algorithm (\u0027clinical.med.prescribed\u0027, start, end)\n                e \u003d AbstractEntity (\u0027data\u0027, \u0027{0}{1}\u0027.format (\u0027http://purl.datasource.org/\u0027, datasource))\n                e.add_attribute (\u0027src\u0027, datasource)\n                provenance.add_entity (\u0027data\u0027, e.to_tuple ())\n            elif \u0027_exposure\u0027 in function.__name__:\n                datasource \u003d \u0027enviro\u0027\n                provenance.add_algorithm (\u0027exposure.pm25-ozone\u0027, start, end)\n                e \u003d AbstractEntity (\u0027data\u0027, \u0027{0}{1}\u0027.format (\u0027http://purl.datasource.org/\u0027, datasource))\n                e.add_attribute (\u0027src\u0027, datasource)\n                provenance.add_entity (\u0027data\u0027, e.to_tuple ())\n            elif \u0027_sparql\u0027 in function.__name__:\n                provenance.add_algorithm (\u0027blazegraph\u0027, start, end)\n                provenance.parse_sparql (args[0])\n        return wrapper\n    return provenance_aspect\n",
      "user": "ad\\scox",
      "dateUpdated": "Mar 24, 2017 10:35:52 PM",
      "config": {
        "colWidth": 12.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python"
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": []
      },
      "apps": [],
      "jobName": "paragraph_1490392173049_585653342",
      "id": "20170324-174933_869005619",
      "dateCreated": "Mar 24, 2017 5:49:33 PM",
      "dateStarted": "Mar 24, 2017 10:35:52 PM",
      "dateFinished": "Mar 24, 2017 10:35:52 PM",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%pyspark\n\np \u003d TranslatorProvenance ()\nstart \u003d p.get_time ()\nend \u003d p.get_time ()\n#p.add_algorithm (\u0027clinical.med.prescribed\u0027, start)\n#p.add_algorithm (\u0027exposure.pm25-ozone\u0027, start, end)\n\n@provenance_aspect(provenance\u003dp)\ndef get_exposure ():\n    import requests\n    exposure \u003d \u0027http://bdtgis.renci.org:9090/v1/exposures/pm25/scores?start_date\u003d1985-04-12\u0026end_date\u003d2018-04-13\u0026exposure_point\u003d35.720278%2C-79.176389\u0026temporal_resolution\u003dday\u0026score_type\u003d7dayrisk\u0027\n    r \u003d requests.get (exposure)\n    print (r.status_code)\n    print (r.json ())\n    \n    print requests.post (\n        \"https://exposures.renci.org/v1/getExposureScore\",\n        data \u003d {\n          \"etime\": \"1985-04-12\",\n          \"exposure\": \"pm25\",\n          \"loc\": \"35.720278,-79.176389,Sa,35.731944,-78.852778,Su\",\n          \"stime\": \"1985-04-12\",\n          \"tres\": \"string\",\n          \"tscore\": \"string\"\n        }).json ()\nget_exposure ()\n\nprint (p)\n    ",
      "user": "ad\\scox",
      "dateUpdated": "Mar 24, 2017 10:37:09 PM",
      "config": {
        "colWidth": 12.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python"
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": [
          {
            "type": "TEXT",
            "data": "200\nTrue\n{u\u0027data\u0027: [{u\u0027end-time\u0027: 0, u\u0027start-time\u0027: 0, u\u0027value\u0027: 16}]}\ndocument\n  default \u003chttp://purl.translator.org/prov/\u003e\n  prefix exposure.pm25-ozone \u003chttp://purl.translator.org/prov/exposure.pm25-ozone\u003e\n  prefix clinical \u003chttp://purl.translator.org/prov/clinical\u003e\n  prefix medbiochem \u003chttp://purl.translator.org/prov/medbiochem\u003e\n  prefix blazegraph \u003chttp://purl.translator.org/prov/blazegraph\u003e\n  prefix enviro \u003chttp://purl.translator.org/prov/enviro\u003e\n  prefix clinical.med.prescribed \u003chttp://purl.translator.org/prov/clinical.med.prescribed\u003e\n  \n  activity(exposure.pm25-ozone, 2017-03-24T22:37:09, 2017-03-24T22:37:09)\n  entity(data, [prov:type\u003d\"data\", src\u003d\"enviro\"])\nendDocument\n"
          }
        ]
      },
      "apps": [],
      "jobName": "paragraph_1490406769603_1276988731",
      "id": "20170324-215249_538470017",
      "dateCreated": "Mar 24, 2017 9:52:49 PM",
      "dateStarted": "Mar 24, 2017 10:37:09 PM",
      "dateFinished": "Mar 24, 2017 10:37:09 PM",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%pyspark\nfrom string import Template\nfrom SPARQLWrapper import SPARQLWrapper2, JSON\nimport urllib2\n\nproxy \u003d urllib2.ProxyHandler({\u0027http\u0027: \u0027gateway.ad.renci.org:8080\u0027})\nopener \u003d urllib2.build_opener(proxy)\nurllib2.install_opener(opener)\n\nblazegraph_uri \u003d \"http://stars-blazegraph.renci.org/bigdata/sparql\"\nblazegraph \u003d SPARQLWrapper2 (blazegraph_uri)\n\n@provenance_aspect(provenance\u003dp)\ndef query_sparql (query, service\u003dblazegraph):\n    service.setQuery (query)\n    service.setReturnFormat (JSON)\n    return service.query().convert ()\n    ",
      "user": "ad\\scox",
      "dateUpdated": "Mar 24, 2017 10:37:11 PM",
      "config": {
        "colWidth": 12.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "scala"
        },
        "editorMode": "ace/mode/scala"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1490406847132_-926560165",
      "id": "20170324-215407_689501181",
      "dateCreated": "Mar 24, 2017 9:54:07 PM",
      "dateStarted": "Mar 24, 2017 10:37:11 PM",
      "dateFinished": "Mar 24, 2017 10:37:11 PM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%pyspark\nsparql_query \u003d \"\"\"\n    PREFIX db_resource:      \u003chttp://chem2bio2rdf.org/drugbank/resource/\u003e\n    PREFIX ctd_chem_disease: \u003chttp://chem2bio2rdf.org/ctd/resource/ctd_chem_disease/\u003e \n    PREFIX biordf:           \u003chttp://bio2rdf.org/\u003e\n    PREFIX ctd:              \u003chttp://chem2bio2rdf.org/ctd/resource/\u003e\n    SELECT DISTINCT ?chem_disease ?meshid ?compound ?drug\n    WHERE {\n      ?chem_disease ctd:diseaseid ?meshid .\n      ?chem_disease ctd:cid       ?compound .\n      ?drug         db_resource:CID ?compound\n    }\"\"\"\nquery_sparql (sparql_query)\n\nprint (p)",
      "user": "ad\\scox",
      "dateUpdated": "Mar 24, 2017 10:37:13 PM",
      "config": {
        "colWidth": 12.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python"
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": [
          {
            "type": "TEXT",
            "data": "document\n  default \u003chttp://purl.translator.org/prov/\u003e\n  prefix exposure.pm25-ozone \u003chttp://purl.translator.org/prov/exposure.pm25-ozone\u003e\n  prefix clinical \u003chttp://purl.translator.org/prov/clinical\u003e\n  prefix medbiochem \u003chttp://purl.translator.org/prov/medbiochem\u003e\n  prefix blazegraph \u003chttp://purl.translator.org/prov/blazegraph\u003e\n  prefix enviro \u003chttp://purl.translator.org/prov/enviro\u003e\n  prefix clinical.med.prescribed \u003chttp://purl.translator.org/prov/clinical.med.prescribed\u003e\n  \n  activity(exposure.pm25-ozone, 2017-03-24T22:37:09, 2017-03-24T22:37:09)\n  entity(data, [prov:type\u003d\"data\", src\u003d\"enviro\"])\n  activity(blazegraph, 2017-03-24T22:37:13, 2017-03-24T22:37:15)\n  entity(data, [prov:type\u003d\"data\", src\u003d\"\u003chttp://bio2rdf.org/\u003e\"])\n  entity(data, [prov:type\u003d\"data\", src\u003d\"c2b2r.drugbank\"])\n  entity(data, [prov:type\u003d\"data\", src\u003d\"c2b2r.ctd\"])\nendDocument\n"
          }
        ]
      },
      "apps": [],
      "jobName": "paragraph_1490408323060_-545760566",
      "id": "20170324-221843_448980876",
      "dateCreated": "Mar 24, 2017 10:18:43 PM",
      "dateStarted": "Mar 24, 2017 10:37:13 PM",
      "dateFinished": "Mar 24, 2017 10:37:15 PM",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%pyspark\n",
      "user": "ad\\scox",
      "dateUpdated": "Mar 24, 2017 10:19:38 PM",
      "config": {},
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1490408378860_-1662024394",
      "id": "20170324-221938_154927284",
      "dateCreated": "Mar 24, 2017 10:19:38 PM",
      "status": "READY",
      "progressUpdateIntervalMs": 500
    }
  ],
  "name": "/NCATSTranslator/Green/Provenance",
  "id": "2CC6EKV1B",
  "angularObjects": {
    "2C8PNVW4G:shared_process": [],
    "2C9WWVYVN::2CC6EKV1B": [],
    "2C9M4A84U:shared_process": [],
    "2C8JB5J2A:shared_process": [],
    "2C8UPVAV8:shared_process": [],
    "2CB6QSJQK:shared_process": [],
    "2CB4GRYA4:shared_process": [],
    "2CAZ1XA1G:shared_process": [],
    "2CBGUDB9H:shared_process": [],
    "2C9VT2CHD:shared_process": [],
    "2CBBPS1GQ:shared_process": [],
    "2CAYF7YMG:shared_process": [],
    "2C7NS2RPM:shared_process": [],
    "2CB55MCKF:shared_process": [],
    "2C9P6TDB4:shared_process": [],
    "2C7YD2D51:shared_process": [],
    "2C9UAC7QR:shared_process": [],
    "2C8K1VZ6J:shared_process": [],
    "2CA9JMF94:shared_process": []
  },
  "config": {},
  "info": {}
}